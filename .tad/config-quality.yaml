# TAD Config Module: Quality Assurance
# Part of TAD config.yaml modular split (v2.2)
# Contains: quality_gates, evidence_based_verification, mandatory_questions,
#           progressive_validation, subagents_enforcement, template_triggers
# Consumers: tad-alex.md, tad-blake.md, tad-gate.md
# ==================== Sub-agents 强制调用机制 ====================
subagents_enforcement:
  # 强制调用规则
  mandatory_invocation_rules:
    agent_a:
      需求分析:
        must_call: ["product-expert"]
        violation: "未调用product-expert进行需求分析"

      架构设计:
        must_call: ["backend-architect"]
        violation: "未调用backend-architect进行架构设计"

      质量审查:
        must_call: ["code-reviewer"]
        violation: "未调用code-reviewer进行质量审查"

    agent_b:
      复杂任务:
        condition: "任务包含3个以上组件"
        must_call: ["parallel-coordinator"]
        violation: "复杂任务未使用parallel-coordinator"

      问题修复:
        condition: "遇到bug或错误"
        must_call: ["bug-hunter"]
        violation: "未调用bug-hunter诊断问题"

      测试执行:
        condition: "完成实现后"
        must_call: ["test-runner"]
        violation: "未调用test-runner验证实现"

  # 调用验证机制
  invocation_verification:
    log_format: "[{timestamp}] {agent} called {subagent} for {task}"
    verification_points:
      - pre_task: "检查是否需要sub-agent"
      - during_task: "确认sub-agent被调用"
      - post_task: "验证sub-agent完成工作"

  # 违规处理
  violation_handling:
    detection: "自动检测未调用必需的sub-agents"
    warning: "⚠️ VIOLATION: {violation_message}"
    correction: "立即调用缺失的sub-agent"
    prevention: "阻止继续执行直到调用"

# ==================== 质量门控（Quality Gates） ====================
quality_gates:
  # Agent A 质量门控
  agent_a_gates:
    gate1_requirement:
      name: "需求完整性"
      checks:
        - "用户价值明确"
        - "验收标准清晰"
        - "至少3轮确认"
      violation_action: "阻止进入设计阶段"

    gate2_design:
      name: "设计完整性"
      checks:
        - "所有组件都有设计"
        - "数据流完整"
        - "错误处理明确"
      violation_action: "返回补充设计"

    gate3_handoff:
      name: "交接完整性"
      checks:
        - "实施步骤详细"
        - "依赖关系清晰"
        - "测试用例提供"
      violation_action: "禁止提交给Agent B"

  # Agent B 质量门控
  agent_b_gates:
    gate1_prereq:
      name: "前置条件"
      checks:
        - "handoff文档存在"
        - "设计已批准"
        - "环境已就绪"
      violation_action: "拒绝执行"

    gate2_implementation:
      name: "实现质量"
      checks:
        - "代码可编译"
        - "函数都存在"
        - "类型检查通过"
      violation_action: "立即修复"

    gate3_verification:
      name: "验证完整性"
      checks:
        - "测试全部通过"
        - "覆盖率达标"
        - "性能符合要求"
      violation_action: "禁止交付"

  # ==================== TAD v2.0 Gate Redefinition ====================
  # Gate 3 and Gate 4 are redefined with Ralph Loop integration
  # Gate 3: Expanded to include all technical quality checks
  # Gate 4: Simplified to pure business acceptance

  gate3_v2_implementation_integration:
    name: "Implementation & Integration Quality"
    version: "2.0"
    owner: "Blake"
    description: "All technical quality checks - Ralph Loop + original Gate 3 + Gate 4 Part A"

    # Ralph Loop Evidence (Required)
    ralph_loop_evidence:
      required: true
      config_file: ".tad/ralph-config/loop-config.yaml"
      checks:
        - "Ralph Loop completed successfully (no abort/escalation)"
        - "State file shows clean completion"
        - "Summary file generated"
      evidence_required:
        - ".tad/evidence/ralph-loops/{task_id}_state.yaml"
        - ".tad/evidence/ralph-loops/{task_id}_summary.md"

    # Expert Evidence (Required)
    expert_evidence:
      required: true
      files:
        - type: "code-review"
          pattern: ".tad/evidence/reviews/{date}-code-review-{task}-final.md"
          required: true
        - type: "testing-review"
          pattern: ".tad/evidence/reviews/{date}-testing-review-{task}-final.md"
          required: true
        - type: "security-review"
          pattern: ".tad/evidence/reviews/{date}-security-review-{task}-*.md"
          required: false  # Only if triggered
        - type: "performance-review"
          pattern: ".tad/evidence/reviews/{date}-performance-review-{task}-*.md"
          required: false  # Only if triggered

    # Acceptance Verification Evidence (Required)
    acceptance_verification_evidence:
      required: true
      files:
        - type: "acceptance-verification-report"
          pattern: ".tad/evidence/acceptance-tests/{task_id}/acceptance-verification-report.md"
          required: true
        - type: "verification-scripts"
          pattern: ".tad/evidence/acceptance-tests/{task_id}/AC-*.*"
          required: true
          min_count: "must match acceptance criteria count"

    # Original Gate 3 Checks
    implementation_quality:
      checks:
        - "Code compiles without errors"
        - "All functions referenced in handoff exist"
        - "Type checking passes"
        - "No linting errors"

    # Moved from Gate 4 Part A
    integration_verification:
      checks:
        - "All tests pass (unit + integration)"
        - "Coverage meets threshold"
        - "No regression in existing functionality"

    # Knowledge Assessment (MANDATORY)
    knowledge_assessment:
      required: true
      blocking: true
      questions:
        - "New discoveries during implementation? (Yes/No)"
        - "Category (if yes)"
        - "Brief summary"
      output_location: ".tad/project-knowledge/{category}.md"

    human_trigger:
      command: "/gate 3"
      description: "Blake completes Ralph Loop, Human triggers Gate 3 to confirm"

  gate4_v2_acceptance_archive:
    name: "Acceptance & Archive"
    version: "2.0"
    owner: "Alex"
    description: "Pure business validation - technical quality already verified by Gate 3"

    # Pre-condition
    prerequisite:
      - "Gate 3 v2 passed"
      - "Blake's completion report received"

    # Business Acceptance (Focus)
    acceptance:
      checks:
        - "Business value delivered matches handoff intent"
        - "User requirements satisfied"
        - "No unexpected side effects on user experience"

      # Review evidence only - no re-run needed
      evidence_review:
        description: "Review Blake's Gate 3 evidence (not re-execute)"
        files:
          - "{task_id}_summary.md"
          - "Final code-review report"
          - "Final testing-review report"

      # Optional subagent calls (business focus)
      optional_experts:
        - name: "ux-expert-reviewer"
          when: "UI/UX changes involved"
        - name: "product-expert"
          when: "Complex business logic"

    # Archive
    archive:
      actions:
        - "Move handoff to .tad/archive/by_task/"
        - "Move evidence to .tad/archive/evidence/"
        - "Update NEXT.md with completion status"

    # Knowledge Assessment (MANDATORY)
    knowledge_assessment:
      required: true
      blocking: true
      questions:
        - "New discoveries during acceptance? (Yes/No)"
        - "Category (if yes)"
        - "Brief summary"
      output_location: ".tad/project-knowledge/{category}.md"

    human_trigger:
      command: "/gate 4"
      description: "Alex reviews completion report and triggers Gate 4"

  # Gate Responsibility Matrix (TAD v2.0)
  gate_responsibility_matrix:
    description: "Clear separation of Gate 3 and Gate 4 responsibilities"
    version: "2.0"

    matrix:
      test-runner:
        gate3: "Required (Layer 2)"
        gate4: "N/A"
        notes: "Already verified by Blake"

      code-reviewer:
        gate3: "Required (Layer 2)"
        gate4: "Optional (second opinion)"
        notes: "Alex can re-run if concerned"

      security-auditor:
        gate3: "Conditional (Layer 2)"
        gate4: "Optional (verification)"
        notes: "Alex reviews evidence only"

      performance-optimizer:
        gate3: "Conditional (Layer 2)"
        gate4: "Optional (verification)"
        notes: "Alex reviews evidence only"

      ux-expert-reviewer:
        gate3: "N/A"
        gate4: "Optional (if UI involved)"
        notes: "Business/UX focus"

      product-expert:
        gate3: "N/A"
        gate4: "Optional (business logic)"
        notes: "Business focus"

    principles:
      - "Gate 3 (Blake): Technical quality verification - MANDATORY technical experts"
      - "Gate 4 (Alex): Business value acceptance - OPTIONAL business experts, technical experts only review evidence"

# ==================== 证据式验证系统 ====================
evidence_based_verification:
  enabled: true
  description: "所有关键检查点都需要提供可验证的证据"

  required_evidence_types:
    # 证据类型1：搜索结果
    search_result:
      format: "命令 + 结果截图或文本输出"
      purpose: "证明确实搜索了历史代码"
      example: |
        ```bash
        # 搜索命令
        grep -r "calculateScore" src/

        # 结果
        src/lib/utils.ts:42: export function calculateScoreAndReasons(...)
        ```
      human_validation: "能看到搜索命令和结果"
      mandatory_for: ["MQ1"]

    # 证据类型2：代码位置证明
    code_location:
      format: "Markdown表格：函数名 | 文件位置 | 行号 | 代码片段 | 验证状态"
      purpose: "证明函数/组件确实存在"
      example: |
        | 函数名 | 位置 | 行号 | 代码片段 | 验证 |
        |--------|------|------|---------|------|
        | calculateScore | src/lib/utils.ts | 42 | `export function calculateScore(...)` | ✅ |
      human_validation: "能看到具体位置和代码，每个都标记✅"
      mandatory_for: ["MQ2"]

    # 证据类型3：数据流图
    data_flow_diagram:
      format: "Mermaid图 + Markdown对照表"
      purpose: "展示数据从后端到前端的完整流动"
      example: |
        ```mermaid
        graph LR
          A[Backend API] -->|计算| B[score, reasons, warnings]
          B -->|传递| C[Frontend]
          C -->|显示| D[ScoreDisplay]
          C -->|显示| E[ReasonList]
          C -->|显示| F[WarningAlert]
        ```

        | 后端字段 | 前端组件 | 是否显示 | 不显示原因 |
        |---------|---------|---------|-----------|
        | score | ScoreDisplay | ✅ | - |
        | matchReasons | ReasonList | ✅ | - |
      human_validation: "能看到每个字段都有对应的显示组件，或有合理的不显示原因"
      mandatory_for: ["MQ3"]

    # 证据类型4：状态流图
    state_flow_diagram:
      format: "ASCII图或Mermaid状态图"
      purpose: "展示状态的来源、存储位置、同步时机"
      example: |
        [用户输入] → preferences.allergens (主状态，Source of Truth)
                      ↓ 同步时机：onSubmit事件
                   dietaryRestrictions.allergies (备份状态)
      human_validation: "能看到是否有多处存储、谁是主状态、何时同步"
      mandatory_for: ["MQ5"]

    # 证据类型5：UI截图
    ui_screenshot:
      format: "浏览器截图或UI mockup"
      purpose: "证明功能的视觉效果"
      example: "浏览器截图显示推荐理由和警告的视觉层级"
      human_validation: "能看到实际显示效果，视觉层级清晰"
      mandatory_for: ["MQ4", "Phase完成报告"]

    # 证据类型6：测试结果
    test_result:
      format: "测试运行截图或日志输出"
      purpose: "证明代码能运行、测试通过"
      example: |
        ```
        ✓ 42 tests passing
        ✓ Coverage: 87%
        ```
      human_validation: "能看到测试通过（passed/绿色✓），覆盖率达标"
      mandatory_for: ["Phase完成报告"]

# ==================== 强制回答问题系统 ====================
mandatory_questions:
  enabled: true
  blocking: true
  auto_sync: true
  source: ".tad/archive/evidence/patterns/failure-patterns.md"
  description: "从历史失败中提炼的必须回答的问题"

  # 问题库
  questions:
    MQ1_historical_code:
      id: "MQ1"
      pattern_source: "Failure Pattern 2: Creating Instead of Searching"
      trigger_keywords: ["之前的", "原来的", "我们的方案", "previous", "original", "existing"]
      trigger_condition: "用户描述中提到历史方案或现有功能"

      question: "用户提到了历史方案，你找到相关代码了吗？"
      sub_questions:
        - "搜索了哪些关键词？"
        - "找到了什么？在哪里？"
        - "为什么决定复用/不复用？"

      required_evidence: "search_result"
      evidence_format: "搜索命令 + 完整输出 + 决策说明"
      blocking: true

      human_validation_question: "能看到搜索确实执行了吗？决策理由合理吗？"

    MQ2_function_existence:
      id: "MQ2"
      pattern_source: "Failure Pattern 3: Function Assumption Errors"
      trigger_condition: "设计中包含函数调用或组件引用"

      question: "设计中调用了哪些函数/组件？它们都存在吗？"
      sub_questions:
        - "列出所有将调用的函数/组件"
        - "每个函数在哪个文件的第几行？"
        - "请提供函数定义的代码片段"

      required_evidence: "code_location"
      evidence_format: "Markdown表格，每个函数/组件都有位置证明"
      blocking: true

      human_validation_question: "每个函数都有✅存在标记和具体位置吗？"

    MQ3_data_flow:
      id: "MQ3"
      pattern_source: "Failure Pattern 4: Incomplete Data Flow"
      trigger_condition: "后端计算或返回数据给前端"

      question: "后端计算/返回了哪些字段？前端都显示了吗？"
      sub_questions:
        - "后端返回的完整字段列表"
        - "每个字段在前端的哪个组件显示？"
        - "有没有字段不显示？为什么？"

      required_evidence: "data_flow_diagram"
      evidence_format: "数据流图（Mermaid）+ 对照表"
      blocking: true

      human_validation_question: |
        - 后端每个字段都有对应的前端组件吗？
        - "❌不显示"的字段有合理原因吗？

    MQ4_visual_hierarchy:
      id: "MQ4"
      pattern_source: "Failure Pattern 5: Visual Uniformity Disease"
      trigger_condition: "功能有多个状态、类型或优先级"

      question: "这个功能有不同的状态/类型吗？用户如何视觉上区分？"
      sub_questions:
        - "有哪些不同的状态？（如：推荐/不推荐，成功/失败）"
        - "每个状态的视觉表现是什么？（颜色、图标、文字）"
        - "用户能一眼看出区别吗？"

      required_evidence: "ui_screenshot"
      evidence_format: "UI状态对比表 + 截图/mockup"
      blocking: false  # 警告但不阻塞

      human_validation_question: "从截图能看出不同状态的明显区别吗？"

    MQ5_state_sync:
      id: "MQ5"
      pattern_source: "Real Issue: Dual State Sync Problem"
      trigger_condition: "涉及用户输入、状态管理或前后端数据传递"

      question: "数据存在几个地方？它们什么时候同步？"
      sub_questions:
        - "列出所有存储这个数据的地方（前端state/localStorage/后端session/database）"
        - "哪个是主状态（Source of Truth）？"
        - "其他状态什么时候同步？用什么触发？"
        - "如果忘记同步会怎样？用户会看到什么？"

      required_evidence: "state_flow_diagram"
      evidence_format: "状态流图，标注主状态、同步时机和触发条件"
      blocking: true

      human_validation_question: |
        - 清楚标注哪个是主状态了吗？
        - 同步时机明确吗？
        - 或确认只有单一状态？

    MQ6_technical_research:
      id: "MQ6"
      pattern_source: "v1.4 Enhancement: Proactive Technical Research"
      trigger_condition: "任何技术决策（框架选择、库使用、架构模式、实现方案）"

      question: "这个技术决策，你搜索过最新方案了吗？"
      sub_questions:
        - "搜索了哪些关键词？"
        - "找到了哪些候选方案？"
        - "为什么选择当前方案而非其他？"
        - "有没有更新的替代方案？"

      required_evidence: "technical_research_result"
      evidence_format: |
        ## 技术调研记录
        | 搜索关键词 | 发现的方案 | 优点 | 缺点 | 是否采用 |
        |-----------|-----------|------|------|---------|
        | xxx | 方案A | ... | ... | ✅/❌ |
      blocking: true

      human_validation_question: |
        - 搜索范围够广吗？
        - 候选方案对比合理吗？
        - 选择理由清晰吗？

      # MQ6 深度自动判断机制
      depth_auto_detection:
        principle: "宁可多搜，不要漏搜"

        quick_scan:
          trigger: "简单配置、常见用法、成熟技术"
          action: "快速确认最佳实践"
          time: "1-2分钟"
          example: "React useState 用法"

        standard_search:
          trigger: "技术选型、库对比、架构模式"
          action: "搜索2-3个方案对比"
          time: "5-10分钟"
          example: "状态管理选型 Redux vs Zustand vs Jotai"

        deep_research:
          trigger: "核心架构、创新方案、用户明确要求"
          action: "深度调研，查找GitHub项目、最新文章"
          time: "15-30分钟"
          example: "AI驱动的菜单推荐系统架构"

        auto_escalation:
          - "搜索结果不确定 → 升级到下一档"
          - "发现新技术趋势 → 主动深入"
          - "Human表示关注 → 自动深度调研"

  # 执行机制
  enforcement:
    when: "Gate 2 (Design Completeness)"
    how: "Alex必须在handoff中包含'强制问题回答'章节"
    validation: "Human检查每个触发的MQ是否都有回答+证据"
    consequence_missing: "证据不完整 → 阻止提交handoff，要求补充"
    consequence_incomplete: "证据质量低 → Human要求重新提供"

  # 自动更新机制
  auto_update_pipeline:
    trigger: "Human纠正了AI的错误或发现新的失败模式"
    process: |
      1. 捕获错误类型和根因（创建Failure Learning Entry）
      2. 判断：这个错误应该由哪个MQ拦截？
      3. 如果现有MQ未覆盖：
         - 生成新MQ建议（MQ6、MQ7...）
         - 提交Human审核
         - 审核通过后自动添加到config.yaml
      4. 如果现有MQ应该拦截但没拦：
         - 分析为什么没拦住（trigger条件不够？evidence不够？）
         - 优化MQ的trigger条件或evidence要求
         - 更新config.yaml
    output_location: ".tad/archive/evidence/failures/[timestamp]_mq_update.yaml"

# ==================== 渐进式验证系统 ====================
progressive_validation:
  enabled: true
  description: "将大任务分解为Phase，每个Phase后Human验证"

  phase_structure:
    definition: |
      Phase是功能的逻辑组成部分，每个Phase：
      - 有明确的交付物（代码、文档、测试）
      - 有独立的验证标准
      - 完成后需要Human审查才能继续

    size_guideline:
      small_task: "1个Phase，1-2小时完成"
      medium_task: "2-3个Phase，每个Phase 2-3小时"
      large_task: "4-6个Phase，每个Phase不超过4小时"

    mandatory_checkpoint: "每个Phase完成时Blake必须提供证据，Human必须审查"

  phase_evidence_requirements:
    every_phase_must_provide:
      - code_screenshot: "关键函数/组件的代码截图"
      - test_result: "该Phase相关的测试结果"
      - ui_screenshot: "如果有UI变化，提供浏览器截图"
      - progress_notes: "遇到的问题和解决方法"

    human_checkpoint_questions:
      - "这是我期望的方向吗？"
      - "测试通过了吗？（看到passed/绿色✓）"
      - "需要调整什么吗？"

    continue_criteria: "Human确认方向正确"
    adjustment_process: "如果需要调整，Blake修改本Phase后重新提交证据"

  gate_phase_binding:
    description: "将Quality Gates绑定到Phase"

    gate2_design_phases:
      phase: "设计阶段各Phase（如果设计分多个Phase）"
      checkpoint_type: "design_evidence"
      timing: "每完成一个设计模块"
      human_action: "审查设计图表和证据"

    gate3_implementation_phases:
      phase: "实现阶段各Phase"
      checkpoint_type: "implementation_evidence"
      timing: "每完成一个Phase"
      human_action: "审查代码截图、测试结果、UI效果"
      continue_criteria: "Human确认方向正确才能继续下个Phase"

# ==================== Sub-Agent强制使用 ====================
subagent_enforcement_v13:
  enabled: true
  description: "从建议变成强制，带证据验证"

  agent_a_mandatory:
    product_expert:
      when: "需求分析阶段（Round 1后）"
      must_call: true
      evidence_required: "在需求文档中包含product-expert的分析结果"
      evidence_format: "用户画像、用例分析、业务价值评估"
      violation_action: "阻止进入设计阶段"

    backend_architect:
      when: "设计系统架构（涉及API/数据库/微服务等）"
      must_call: true
      evidence_required: "在设计文档中包含backend-architect的建议"
      evidence_format: "架构图、技术选型、扩展性分析"
      violation_action: "阻止创建handoff"

    code_reviewer:
      when: "审查Blake的实现"
      must_call: true
      evidence_required: "在审查报告中包含code-reviewer的发现"
      evidence_format: "代码质量评分、问题列表、改进建议"
      violation_action: "阻止标记为完成"

  agent_b_mandatory:
    parallel_coordinator:
      when: "任务包含3个以上独立组件"
      must_call: true
      detection: "自动检测handoff中的Phase数量≥3"
      evidence_required: "在完成报告中说明如何使用parallel-coordinator"
      evidence_format: "任务分解、并行执行计划、协调机制"
      violation_action: "警告并要求说明为什么不用"

    bug_hunter:
      when: "出现错误或测试失败"
      must_call: true
      detection: "自动检测错误日志或测试失败"
      evidence_required: "在修复报告中包含bug-hunter的诊断"
      evidence_format: "根因分析、修复方案、预防措施"
      violation_action: "阻止标记为修复完成"

    test_runner:
      when: "完成实现"
      must_call: true
      detection: "Phase完成时"
      evidence_required: "测试结果截图或报告"
      evidence_format: "测试通过率、覆盖率、失败case"
      violation_action: "阻止进入下个Phase"

  evidence_format:
    subagent_usage_log: |
      ## Sub-Agent使用记录

      | Sub-Agent | 是否调用 | 调用时机 | 输出摘要 | 证据链接 |
      |-----------|---------|---------|---------|---------|
      | product-expert | ✅ | Round 1后 | 识别了3个关键用例 | [链接到分析文档] |
      | backend-architect | ✅ | 设计阶段 | 建议使用Two-phase架构 | [链接到架构图] |
      | parallel-coordinator | ❌ | N/A | 任务只有2个组件，不需要 | N/A |

  human_verification:
    what_to_check: "Sub-Agent使用记录表是否完整"
    red_flags:
      - "应该调用但标记为'❌'且无合理原因"
      - "调用了但'输出摘要'为空"
      - "'证据链接'都是N/A"

# ==================== Template Trigger System (v1.0) ====================
template_triggers:
  version: "1.0"
  enabled: true
  description: "模板触发和存储系统 - 确保 subagent 输出格式一致并留存证据"

  storage:
    base_path: ".tad/evidence/reviews/"
    naming: "{date}-{type}-{brief}.md"
    date_format: "YYYY-MM-DD"

  # MANDATORY: Subagent 必须输出，Gate 检查文件存在
  mandatory:
    gate_3:
      subagent: test-runner
      template: testing-review-format
      template_path: ".tad/templates/output-formats/testing-review-format.md"
      evidence_path: ".tad/evidence/reviews/{date}-testing-review-{task}.md"
      blocking: true
      description: "Gate 3 通过前必须有测试审查证据"

    gate_4:
      subagents:
        - subagent: security-auditor
          template: security-review-format
          template_path: ".tad/templates/output-formats/security-review-format.md"
          evidence_path: ".tad/evidence/reviews/{date}-security-review-{task}.md"
        - subagent: performance-optimizer
          template: performance-review-format
          template_path: ".tad/templates/output-formats/performance-review-format.md"
          evidence_path: ".tad/evidence/reviews/{date}-performance-review-{task}.md"
      blocking: true
      description: "Gate 4 通过前必须有安全和性能审查证据"

  # RECOMMENDED: Subagent 应该输出，但不阻塞
  recommended:
    code_review:
      subagent: code-reviewer
      templates:
        - git-workflow-format
        - refactoring-review-format
      trigger: "*review 命令"
      blocking: false
      description: "代码审查时推荐使用的模板"

    refactoring:
      subagent: refactor-specialist
      template: refactoring-review-format
      trigger: "重构任务"
      blocking: false
      description: "重构任务时推荐使用的模板"

  # SELF-USE: Agent 自用，纯参考
  self_use:
    alex_design:
      templates:
        - api-review-format
        - architecture-review-format
        - database-review-format
        - ui-review-format
        - ux-research-format
      trigger: "*design 或 *analyze 命令，Alex 根据任务类型选用"
      description: "Alex 设计阶段可参考的模板"

    blake_implement:
      templates:
        - debugging-format
        - error-handling-format
      trigger: "*debug 或 *implement 命令，Blake 根据需要选用"
      description: "Blake 实现阶段可参考的模板"

  # Enforcement rules
  enforcement:
    gate_3_check:
      description: "Gate 3 通过条件"
      requirements:
        - "COMPLETION-*.md exists in .tad/active/handoffs/"
        - "test-runner subagent was called"
        - "testing-review evidence file exists in .tad/evidence/reviews/"
      blocking: true

    gate_4_check:
      description: "Gate 4 通过条件"
      requirements:
        - "security-auditor subagent was called"
        - "performance-optimizer subagent was called"
        - "security-review evidence file exists in .tad/evidence/reviews/"
        - "performance-review evidence file exists in .tad/evidence/reviews/"
      blocking: true

