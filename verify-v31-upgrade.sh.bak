#!/bin/bash

echo "========================================"
echo "TAD v3.1 升级验证脚本"
echo "========================================"
echo ""

# 颜色定义
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 验证计数
PASS=0
FAIL=0

# 验证函数
verify() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}✅ PASS${NC}: $2"
        ((PASS++))
    else
        echo -e "${RED}❌ FAIL${NC}: $2"
        ((FAIL++))
    fi
}

echo "1. 验证配置文件..."
echo "-----------------------------------"

# 检查config.yaml存在
[ -f ".tad/config.yaml" ]
verify $? "config.yaml 文件存在"

# 检查YAML语法
python3 -c "import yaml; yaml.safe_load(open('.tad/config.yaml'))" 2>/dev/null
verify $? "config.yaml YAML语法正确"

# 检查v3.1关键配置
grep -q "tad_version: 3.1" .tad/config.yaml
verify $? "tad_version 设置为 3.1.0"

grep -q "mandatory_questions:" .tad/config.yaml
verify $? "mandatory_questions 配置存在"

grep -q "evidence_based_verification:" .tad/config.yaml
verify $? "evidence_based_verification 配置存在"

grep -q "progressive_validation:" .tad/config.yaml
verify $? "progressive_validation 配置存在"

grep -q "learning_mechanisms:" .tad/config.yaml
verify $? "learning_mechanisms 配置存在"

echo ""
echo "2. 验证模板文件..."
echo "-----------------------------------"

# 检查handoff模板
[ -f ".tad/templates/handoff-a-to-b.md" ]
verify $? "handoff-a-to-b.md 模板存在"

grep -q "## 5. 🆕 强制问题回答" .tad/templates/handoff-a-to-b.md
verify $? "handoff模板包含MQ部分"

grep -q "### MQ1: 历史代码搜索" .tad/templates/handoff-a-to-b.md
verify $? "handoff模板包含MQ1"

grep -q "### MQ5: 状态同步" .tad/templates/handoff-a-to-b.md
verify $? "handoff模板包含MQ5"

grep -q "Handoff Version: 3.1.0" .tad/templates/handoff-a-to-b.md
verify $? "handoff模板版本标记为3.1.0"

echo ""
echo "3. 验证指南文件..."
echo "-----------------------------------"

[ -f ".tad/guides/human-quick-reference.md" ]
verify $? "Human快速参考指南存在"

[ -f ".tad/guides/evidence-collection-guide.md" ]
verify $? "证据收集指南存在"

echo ""
echo "4. 验证目录结构..."
echo "-----------------------------------"

[ -d ".tad/evidence" ]
verify $? "evidence 目录存在"

[ -d ".tad/evidence/patterns" ]
verify $? "evidence/patterns 目录存在"

[ -d ".tad/evidence/failures" ]
verify $? "evidence/failures 目录存在"

[ -d ".tad/evidence/metrics" ]
verify $? "evidence/metrics 目录存在"

[ -d ".tad/guides" ]
verify $? "guides 目录存在"

echo ""
echo "5. 验证指标文件..."
echo "-----------------------------------"

[ -f ".tad/evidence/metrics/tad-v31-metrics.yaml" ]
verify $? "指标追踪文件存在"

echo ""
echo "6. 验证备份文件..."
echo "-----------------------------------"

ls .tad/config.yaml.backup.v3.0* >/dev/null 2>&1
verify $? "config.yaml 备份存在"

ls .tad/templates/handoff-a-to-b.md.v3.0.backup >/dev/null 2>&1
verify $? "handoff模板备份存在"

echo ""
echo "7. 验证版本信息..."
echo "-----------------------------------"

[ -f ".tad/version.txt" ]
verify $? "version.txt 文件存在"

grep -q "3.1.0" .tad/version.txt
verify $? "version.txt 内容为 3.1.0"

echo ""
echo "========================================"
echo "验证结果汇总"
echo "========================================"
echo -e "${GREEN}通过: $PASS${NC}"
echo -e "${RED}失败: $FAIL${NC}"
echo ""

if [ $FAIL -eq 0 ]; then
    echo -e "${GREEN}🎉 所有验证通过！TAD v3.1 升级成功！${NC}"
    exit 0
else
    echo -e "${YELLOW}⚠️  有 $FAIL 项验证失败，请检查上述错误${NC}"
    exit 1
fi
